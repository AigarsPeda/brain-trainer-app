import fs from "node:fs";
import path from "node:path";

const rootDir = process.cwd();
const dataDir = path.join(rootDir, "data");
const outputFile = path.join(dataDir, "levelLoaders.generated.ts");

const levelFilePattern = /^math-(\d+)-level\.ts$/;

const files = fs.readdirSync(dataDir);
const levels = files
  .map((fileName) => {
    const match = fileName.match(levelFilePattern);
    if (!match) return null;
    return Number(match[1]);
  })
  .filter((value) => Number.isInteger(value))
  .sort((a, b) => a - b);

if (levels.length === 0) {
  throw new Error("No level files found. Expected files like data/math-1-level.ts");
}

const duplicateLevel = levels.find((level, index) => levels.indexOf(level) !== index);
if (duplicateLevel !== undefined) {
  throw new Error(`Duplicate level file detected for level ${duplicateLevel}`);
}

const lines = [];
lines.push("// This file is auto-generated by scripts/generate-level-loaders.mjs");
lines.push("// Do not edit manually.");
lines.push("");
lines.push('import type { TaskType } from "@/context/app.context.reducer";');
lines.push("");
lines.push("type LevelModule = Partial<Record<`LEVEL_${number}`, TaskType[]>>;");
lines.push("type LevelLoader = () => LevelModule;");
lines.push("");
lines.push("export const LEVEL_LOADERS: Record<number, LevelLoader> = {");

for (const level of levels) {
  lines.push(`  ${level}: () => require("@/data/math-${level}-level"),`);
}

lines.push("};");
lines.push("");
lines.push(`export const GENERATED_TOTAL_LEVELS = ${levels.length};`);
lines.push("");

fs.writeFileSync(outputFile, `${lines.join("\n")}`, "utf8");
console.log(`Generated ${path.relative(rootDir, outputFile)} with ${levels.length} levels.`);
